<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Filiais e Equipamentos</title>
    <!-- Tailwind CSS CDN - Para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para Ícones - Usado para os ícones nos botões do menu -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter - Para uma tipografia moderna e legível -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo base para a fonte Inter em todo o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para garantir que o contêiner principal do aplicativo ocupe a altura total da tela
           e centralize o conteúdo, com um fundo cinza claro */
        #app-root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Espaçamento interno */
            background-color: #f3f4f6; /* Cor de fundo (equivalente a Tailwind bg-gray-100) */
        }
    </style>
</head>
<body>
    <!-- Contêiner raiz do aplicativo onde todo o conteúdo será dinamicamente injetado pelo JavaScript -->
    <div id="app-root">
        <!-- O conteúdo específico de cada tela (login, menu, formulários) será renderizado aqui -->
        <div id="screen-container" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <!-- Conteúdo dinâmico será carregado aqui -->
        </div>
    </div>

    <!-- Script principal do aplicativo, usando type="module" para importações e escopo de módulo -->
    <script type="module">
        // Importa a função createClient do SDK do Supabase para JavaScript
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Configuração do Supabase ---
        // IMPORTANTE: Substitua estes valores pelo URL e chave ANÔNIMA (anon key) do SEU projeto Supabase.
        // Você pode encontrar estas credenciais no painel do Supabase em 'Project Settings' -> 'API'.
        // Estas chaves são essenciais para que o aplicativo se conecte ao seu banco de dados.
        const SUPABASE_URL = 'https://jtikvjomzduvjrrrsfeg.supabase.co'; // Substitua pelo seu Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0aWt2am9 DDUvjrrrsfegIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMjU3NjcsImV4cCI6MjA2ODcwMTc2N30.2SCuJprMLJROxV6r6z1xKaVnnvy-q0Edwb0DrmcNeEg'; // Substitua pela sua Supabase Anon Key

        // Inicializa o cliente Supabase com as credenciais fornecidas.
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Variáveis de Estado Global ---
        // Estas variáveis simulam o conceito de "estado" em frameworks como React.
        // Elas controlam o que é exibido na tela e os dados da sessão.
        let currentUser = null; // Armazena os dados do usuário atualmente logado (ex: { id, nome, email })
        let currentScreen = 'login'; // Controla qual tela do aplicativo está ativa ('login', 'mainMenu', etc.)
        let authError = null; // Armazena qualquer mensagem de erro relacionada à autenticação
        let appLoading = true; // Indica se o aplicativo está em um estado de carregamento inicial

        // --- Funções Auxiliares de Manipulação de UI (DOM) ---

        /**
         * Atualiza o conteúdo HTML dentro do contêiner principal do aplicativo (`#screen-container`).
         * Esta função é central para a navegação entre as telas do aplicativo.
         * @param {string} htmlContent - A string HTML que será inserida no contêiner.
         * @param {string} maxWidthClass - Uma classe Tailwind CSS para controlar a largura máxima do contêiner.
         */
        function updateScreenContent(htmlContent, maxWidthClass = 'max-w-md') {
            const screenContainer = document.getElementById('screen-container');
            if (screenContainer) {
                screenContainer.innerHTML = htmlContent; // Define o novo HTML
                // Remove quaisquer classes de largura máxima existentes e adiciona a nova
                screenContainer.className = screenContainer.className.split(' ').filter(c => !c.startsWith('max-w-')).join(' ');
                screenContainer.classList.add(maxWidthClass);
            }
        }

        /**
         * Exibe um spinner de carregamento com uma mensagem opcional.
         * Usado para indicar que uma operação assíncrona está em andamento.
         * @param {string} message - A mensagem a ser exibida abaixo do spinner.
         */
        function showLoadingSpinner(message = 'Carregando...') {
            updateScreenContent(`
                <div class="flex flex-col items-center justify-center p-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-2"></div>
                    <p class="text-gray-700">${message}</p>
                </div>
            `);
        }

        /**
         * Gera uma string HTML para exibir uma mensagem de erro formatada.
         * @param {string} message - A mensagem de erro a ser exibida.
         * @returns {string} O HTML da mensagem de erro.
         */
        function showErrorMessage(message) {
            return `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Erro!</strong>
                    <span class="block sm:inline ml-2">${message}</span>
                </div>
            `;
        }

        /**
         * Gera uma string HTML para exibir uma mensagem de sucesso formatada.
         * @param {string} message - A mensagem de sucesso a ser exibida.
         * @returns {string} O HTML da mensagem de sucesso.
         */
        function showSuccessMessage(message) {
            return `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Sucesso!</strong>
                    <span class="block sm:inline ml-2">${message}</span>
                </div>
            `;
        }

        /**
         * Altera a tela atual do aplicativo e aciona uma nova renderização.
         * @param {string} screenName - O nome da tela para a qual o aplicativo deve navegar.
         */
        function navigateTo(screenName) {
            currentScreen = screenName; // Atualiza a variável de estado global da tela
            renderScreen(); // Chama a função que redesenha a UI com base na nova tela
        }

        // --- Funções de Autenticação ---

        /**
         * Tenta realizar o login de um usuário consultando a tabela 'usuarios' no Supabase.
         * @param {string} email - O email fornecido pelo usuário.
         * @param {string} password - A senha fornecida pelo usuário.
         * @returns {Promise<boolean>} Retorna `true` se o login for bem-sucedido, `false` caso contrário.
         */
        async function loginUser(email, password) {
            appLoading = true; // Define o estado de carregamento para mostrar feedback na UI
            authError = null; // Limpa qualquer erro de autenticação anterior
            renderScreen(); // Re-renderiza para mostrar o spinner de carregamento

            try {
                // Realiza uma consulta ao Supabase para encontrar um usuário com o email e senha fornecidos.
                // ATENÇÃO: Em um ambiente de produção, senhas NUNCA devem ser armazenadas em texto puro.
                // Elas devem ser hashadas no banco de dados, e a comparação deve ser feita com hashes.
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*') // Seleciona todas as colunas do usuário
                    .eq('email', email) // Filtra pelo email
                    .eq('senha', password) // Filtra pela senha (não seguro para produção!)
                    .single(); // Espera que a consulta retorne no máximo um registro

                // Verifica se houve um erro do Supabase ou se nenhuma linha foi encontrada (credenciais inválidas)
                if (error && error.code === 'PGRST116') {
                    // 'PGRST116' é um código de erro do PostgREST (parte do Supabase) que significa "nenhuma linha encontrada".
                    throw new Error('Credenciais inválidas. Verifique seu email e senha.');
                } else if (error) {
                    // Lança outros tipos de erro que podem vir do Supabase.
                    throw error;
                }

                if (data) {
                    currentUser = data; // Armazena os dados do usuário logado na variável global
                    return true; // Login bem-sucedido
                }
                return false; // Credenciais não correspondem a nenhum usuário
            } catch (error) {
                console.error('Erro no login:', error.message);
                authError = error.message; // Armazena a mensagem de erro para exibição na UI
                return false; // Login falhou
            } finally {
                appLoading = false; // Finaliza o estado de carregamento
                renderScreen(); // Re-renderiza a tela para refletir o resultado do login
            }
        }

        /**
         * Realiza o logout do usuário.
         * Limpa os dados do usuário logado e redireciona para a tela de login.
         */
        function logoutUser() {
            currentUser = null; // Limpa os dados do usuário
            authError = null; // Limpa quaisquer erros de autenticação
            navigateTo('login'); // Redireciona para a tela de login
        }

        // --- Funções de Renderização de Cada Tela ---

        /**
         * Renderiza a tela de Login.
         * Esta é a tela inicial onde o usuário insere suas credenciais.
         */
        function renderLoginScreen() {
            // Se o aplicativo estiver em estado de carregamento inicial, mostra o spinner
            if (appLoading) {
                showLoadingSpinner('Verificando sessão...');
                return;
            }

            // Se já houver um usuário logado, navega diretamente para o menu principal
            if (currentUser) {
                navigateTo('mainMenu');
                return;
            }

            // Constrói o HTML para a tela de login
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Login</h2>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input
                            type="email"
                            id="email"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                        />
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input
                            type="password"
                            id="password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                        />
                    </div>
                    ${authError ? showErrorMessage(authError) : ''} <!-- Exibe mensagem de erro se houver -->
                    <button
                        type="submit"
                        id="loginButton"
                        class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold text-lg"
                        ${appLoading ? 'disabled' : ''} <!-- Desabilita o botão se estiver carregando -->
                    >
                        ${appLoading ? 'Entrando...' : 'Entrar'}
                    </button>
                </form>
            `);

            // Adiciona o event listener ao formulário de login APÓS ele ser inserido no DOM
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault(); // Previne o recarregamento padrão da página
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const success = await loginUser(email, password); // Tenta fazer o login
                if (success) {
                    navigateTo('mainMenu'); // Se o login for bem-sucedido, navega para o menu principal
                }
            });
        }

        /**
         * Renderiza a tela do Menu Principal.
         * Esta tela é exibida após o login bem-sucedido e oferece opções de navegação.
         */
        function renderMainMenu() {
            // Redireciona para o login se não houver um usuário autenticado
            if (!currentUser) {
                navigateTo('login');
                return;
            }

            // Constrói o HTML para o menu principal
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Bem-vindo, ${currentUser.nome || 'Usuário'}!</h2>
                <p class="text-gray-600 mb-8">Selecione uma opção:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Botão para Cadastro de Filiais -->
                    <button id="btnCadastroFiliais" class="flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transform hover:scale-105 transition duration-300 ease-in-out text-lg font-semibold">
                        <i class="fas fa-building text-3xl mb-2"></i>
                        Cadastro de Filiais
                    </button>
                    <!-- Botão para Cadastro de Equipamentos -->
                    <button id="btnCadastroEquipamentos" class="flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transform hover:scale-105 transition duration-300 ease-in-out text-lg font-semibold">
                        <i class="fas fa-truck-moving text-3xl mb-2"></i>
                        Cadastro de Equipamentos
                    </button>
                    <!-- Botão para Troca de Filial Fixa -->
                    <button id="btnTrocaFilialFixa" class="flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transform hover:scale-105 transition duration-300 ease-in-out text-lg font-semibold">
                        <i class="fas fa-exchange-alt text-3xl mb-2"></i>
                        Troca de Filial Fixa
                    </button>
                    <!-- Botão para Dashboard -->
                    <button id="btnDashboard" class="flex flex-col items-center justify-center p-6 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transform hover:scale-105 transition duration-300 ease-in-out text-lg font-semibold">
                        <i class="fas fa-chart-bar text-3xl mb-2"></i>
                        Dashboard
                    </button>
                </div>
                <!-- Botão para Sair da aplicação -->
                <button id="btnLogout" class="mt-10 px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold">
                    Sair
                </button>
            `, 'max-w-2xl'); // Define uma largura máxima maior para o menu principal

            // Adiciona os event listeners para os botões do menu APÓS o HTML ser renderizado
            document.getElementById('btnCadastroFiliais').addEventListener('click', () => navigateTo('cadastroFiliais'));
            document.getElementById('btnCadastroEquipamentos').addEventListener('click', () => navigateTo('cadastroEquipamentos'));
            document.getElementById('btnTrocaFilialFixa').addEventListener('click', () => navigateTo('trocaFilialFixa'));
            document.getElementById('btnDashboard').addEventListener('click', () => navigateTo('dashboard'));
            document.getElementById('btnLogout').addEventListener('click', logoutUser); // Chama a função de logout
        }

        /**
         * Renderiza a tela de Cadastro de Filiais.
         * Permite ao usuário cadastrar novas filiais e associá-las a um responsável.
         */
        async function renderCadastroFiliaisScreen() {
            // Redireciona para o login se não houver um usuário autenticado
            if (!currentUser) { navigateTo('login'); return; }

            // Variáveis de estado locais para esta tela
            let formMessage = ''; // Mensagem de feedback do formulário (sucesso/erro)
            let formLoading = false; // Indica se o formulário está em processo de envio
            let dataLoading = true; // Indica se os dados iniciais (lista de usuários) estão sendo carregados
            let usuarios = []; // Lista de usuários para preencher o dropdown de responsáveis

            // Função interna para buscar a lista de usuários do Supabase
            const fetchUsuarios = async () => {
                try {
                    const { data, error } = await supabase.from('usuarios').select('id, nome');
                    if (error) throw error; // Lança o erro para ser capturado
                    usuarios = data; // Armazena os usuários na variável local
                } catch (error) {
                    console.error('Erro ao buscar usuários:', error.message);
                    formMessage = 'Erro ao carregar responsáveis: ' + error.message; // Define a mensagem de erro
                } finally {
                    dataLoading = false; // Finaliza o carregamento dos dados
                    renderCadastroFiliaisScreen(); // Re-renderiza a tela para exibir o formulário com os dados carregados
                }
            };

            // Renderiza o HTML da tela de Cadastro de Filiais.
            // Se `dataLoading` for true, mostra um spinner de carregamento.
            // Caso contrário, mostra o formulário.
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Cadastro de Filiais</h2>
                ${dataLoading ? `<div class="flex flex-col items-center justify-center p-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-2"></div><p class="text-gray-700">Carregando responsáveis...</p></div>` : `
                <form id="cadastroFiliaisForm" class="space-y-6">
                    <div>
                        <label for="nomeFilial" class="block text-sm font-medium text-gray-700 mb-1">Nome da Filial</label>
                        <input
                            type="text"
                            id="nomeFilial"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                        />
                    </div>
                    <div>
                        <label for="responsavel" class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                        <select
                            id="responsavel"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                            ${formLoading || usuarios.length === 0 ? 'disabled' : ''} <!-- Desabilita se estiver carregando ou sem usuários -->
                        >
                            <option value="">Selecione um responsável</option>
                            ${usuarios.map(user => `<option value="${user.id}">${user.nome}</option>`).join('')}
                        </select>
                        ${usuarios.length === 0 && !dataLoading ? `<p class="text-red-500 text-xs mt-1">Nenhum responsável encontrado. Cadastre usuários primeiro.</p>` : ''}
                    </div>
                    <div id="formMessageContainer">${formMessage ? (formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage)) : ''}</div>
                    <button
                        type="submit"
                        id="submitFilialBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold text-lg"
                        ${formLoading || usuarios.length === 0 ? 'disabled' : ''} <!-- Desabilita o botão se estiver carregando ou sem responsáveis -->
                    >
                        ${formLoading ? 'Cadastrando...' : 'Cadastrar Filial'}
                    </button>
                </form>
                `}
                <button
                    id="backToMenuBtn"
                    class="mt-6 w-full px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold"
                >
                    Voltar ao Menu
                </button>
            `);

            // Adiciona event listeners APÓS o HTML ser renderizado.
            // Isso garante que os elementos HTML existam antes de tentar acessá-los.
            if (!dataLoading) { // Só adiciona listeners se os dados já foram carregados
                document.getElementById('cadastroFiliaisForm').addEventListener('submit', async (e) => {
                    e.preventDefault(); // Previne o recarregamento da página
                    formLoading = true; // Atualiza o estado de carregamento do formulário
                    formMessage = ''; // Limpa mensagens anteriores
                    // Atualiza o texto e estado do botão de envio
                    document.getElementById('submitFilialBtn').disabled = true;
                    document.getElementById('submitFilialBtn').innerHTML = 'Cadastrando...';
                    document.getElementById('formMessageContainer').innerHTML = ''; // Limpa a área de mensagens

                    const nomeFilial = document.getElementById('nomeFilial').value;
                    const responsavelId = document.getElementById('responsavel').value;

                    try {
                        const { error } = await supabase
                            .from('filiais')
                            .insert([{ nome_filial: nomeFilial, responsavel_id: responsavelId }]);

                        if (error) throw error; // Lança o erro para o bloco catch

                        formMessage = 'Filial cadastrada com sucesso!'; // Mensagem de sucesso
                        // Limpa os campos do formulário
                        document.getElementById('nomeFilial').value = '';
                        document.getElementById('responsavel').value = '';
                    } catch (error) {
                        console.error('Erro ao cadastrar filial:', error.message);
                        formMessage = 'Erro ao cadastrar filial: ' + error.message; // Mensagem de erro
                    } finally {
                        formLoading = false; // Finaliza o carregamento do formulário
                        // Restaura o estado do botão de envio e exibe a mensagem de feedback
                        document.getElementById('submitFilialBtn').disabled = false;
                        document.getElementById('submitFilialBtn').innerHTML = 'Cadastrar Filial';
                        document.getElementById('formMessageContainer').innerHTML = formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage);
                    }
                });
            }
            document.getElementById('backToMenuBtn').addEventListener('click', () => navigateTo('mainMenu'));

            // Inicia a busca por usuários quando a tela é carregada pela primeira vez
            if (dataLoading) {
                fetchUsuarios();
            }
        }

        /**
         * Renderiza a tela de Cadastro de Equipamentos.
         * Permite ao usuário cadastrar novos equipamentos (placa e tipo).
         */
        async function renderCadastroEquipamentosScreen() {
            // Redireciona para o login se não houver um usuário autenticado
            if (!currentUser) { navigateTo('login'); return; }

            // Variáveis de estado locais para esta tela
            let formMessage = ''; // Mensagem de feedback do formulário
            let formLoading = false; // Indica se o formulário está em processo de envio
            // Lista de tipos de equipamento permitidos para validação e preenchimento do dropdown
            const tiposPermitidos = ['Bomba Lança', 'Bomba Estacionária', 'Betoneira'];

            // Constrói o HTML para a tela de Cadastro de Equipamentos
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Cadastro de Equipamentos</h2>
                <form id="cadastroEquipamentosForm" class="space-y-6">
                    <div>
                        <label for="placa" class="block text-sm font-medium text-gray-700 mb-1">Número da Placa</label>
                        <input
                            type="text"
                            id="placa"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                        />
                    </div>
                    <div>
                        <label for="tipoEquipamento" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Equipamento</label>
                        <select
                            id="tipoEquipamento"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                            ${formLoading ? 'disabled' : ''} <!-- Desabilita o select durante o envio -->
                        >
                            <option value="">Selecione o tipo</option>
                            ${tiposPermitidos.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('')}
                        </select>
                    </div>
                    <div id="formMessageContainer">${formMessage ? (formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage)) : ''}</div>
                    <button
                        type="submit"
                        id="submitEquipamentoBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold text-lg"
                        ${formLoading ? 'disabled' : ''} <!-- Desabilita o botão durante o envio -->
                    >
                        ${formLoading ? 'Cadastrando...' : 'Cadastrar Equipamento'}
                    </button>
                </form>
                <button
                    id="backToMenuBtn"
                    class="mt-6 w-full px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold"
                >
                    Voltar ao Menu
                </button>
            `);

            // Adiciona o event listener ao formulário APÓS o HTML ser renderizado
            document.getElementById('cadastroEquipamentosForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                formLoading = true;
                formMessage = '';
                document.getElementById('submitEquipamentoBtn').disabled = true;
                document.getElementById('submitEquipamentoBtn').innerHTML = 'Cadastrando...';
                document.getElementById('formMessageContainer').innerHTML = '';

                const placa = document.getElementById('placa').value;
                const tipoEquipamento = document.getElementById('tipoEquipamento').value;

                // Validação para garantir que o tipo de equipamento selecionado é válido
                if (!tiposPermitidos.includes(tipoEquipamento)) {
                    formMessage = 'Tipo de equipamento inválido. Selecione um dos tipos permitidos.';
                    formLoading = false;
                    document.getElementById('submitEquipamentoBtn').disabled = false;
                    document.getElementById('submitEquipamentoBtn').innerHTML = 'Cadastrar Equipamento';
                    document.getElementById('formMessageContainer').innerHTML = showErrorMessage(formMessage);
                    return; // Interrompe a função se a validação falhar
                }

                try {
                    const { error } = await supabase
                        .from('equipamentos')
                        .insert([{ placa: placa, tipo_equipamento: tipoEquipamento }]);

                    if (error) throw error;

                    formMessage = 'Equipamento cadastrado com sucesso!';
                    document.getElementById('placa').value = ''; // Limpa o campo da placa
                    document.getElementById('tipoEquipamento').value = ''; // Limpa a seleção do tipo
                } catch (error) {
                    console.error('Erro ao cadastrar equipamento:', error.message);
                    formMessage = 'Erro ao cadastrar equipamento: ' + error.message;
                } finally {
                    formLoading = false;
                    document.getElementById('submitEquipamentoBtn').disabled = false;
                    document.getElementById('submitEquipamentoBtn').innerHTML = 'Cadastrar Equipamento';
                    document.getElementById('formMessageContainer').innerHTML = formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage);
                }
            });
            document.getElementById('backToMenuBtn').addEventListener('click', () => navigateTo('mainMenu'));
        }

        /**
         * Renderiza a tela de Troca de Filial Fixa.
         * Permite ao usuário registrar a movimentação de um equipamento entre filiais.
         */
        async function renderTrocaFilialFixaScreen() {
            // Redireciona para o login se não houver um usuário autenticado
            if (!currentUser) { navigateTo('login'); return; }

            // Variáveis de estado locais para esta tela
            let formMessage = '';
            let formLoading = false;
            let dataLoading = true; // Indica se os dados iniciais (equipamentos e filiais) estão carregando
            let equipamentos = []; // Lista de equipamentos para o dropdown
            let filiais = []; // Lista de filiais para o dropdown

            // Função interna para buscar equipamentos e filiais do Supabase
            const fetchData = async () => {
                try {
                    const { data: eqData, error: eqError } = await supabase.from('equipamentos').select('id, placa');
                    const { data: filData, error: filError } = await supabase.from('filiais').select('id, nome_filial');

                    if (eqError) throw eqError;
                    equipamentos = eqData; // Armazena os equipamentos

                    if (filError) throw filError;
                    filiais = filData; // Armazena as filiais
                } catch (error) {
                    console.error('Erro ao buscar dados:', error.message);
                    formMessage = 'Erro ao carregar equipamentos ou filiais: ' + error.message;
                } finally {
                    dataLoading = false; // Finaliza o carregamento dos dados
                    renderTrocaFilialFixaScreen(); // Re-renderiza a tela para exibir o formulário com os dados carregados
                }
            };

            // Renderiza o HTML da tela de Troca de Filial Fixa.
            // Se `dataLoading` for true, mostra um spinner. Caso contrário, mostra o formulário.
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Troca de Filial Fixa</h2>
                ${dataLoading ? `<div class="flex flex-col items-center justify-center p-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-2"></div><p class="text-gray-700">Carregando dados...</p></div>` : `
                <form id="trocaFilialFixaForm" class="space-y-6">
                    <div>
                        <label for="equipamento" class="block text-sm font-medium text-gray-700 mb-1">Selecionar Equipamento</label>
                        <select
                            id="equipamento"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                            ${formLoading || equipamentos.length === 0 ? 'disabled' : ''} <!-- Desabilita se estiver carregando ou sem equipamentos -->
                        >
                            <option value="">Selecione uma placa</option>
                            ${equipamentos.map(eq => `<option value="${eq.id}">${eq.placa}</option>`).join('')}
                        </select>
                        ${equipamentos.length === 0 && !dataLoading ? `<p class="text-red-500 text-xs mt-1">Nenhum equipamento encontrado. Cadastre equipamentos primeiro.</p>` : ''}
                    </div>
                    <div>
                        <label for="novaFilial" class="block text-sm font-medium text-gray-700 mb-1">Nova Filial Fixa</label>
                        <select
                            id="novaFilial"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                            ${formLoading || filiais.length === 0 ? 'disabled' : ''} <!-- Desabilita se estiver carregando ou sem filiais -->
                        >
                            <option value="">Selecione a nova filial</option>
                            ${filiais.map(filial => `<option value="${filial.id}">${filial.nome_filial}</option>`).join('')}
                        </select>
                        ${filiais.length === 0 && !dataLoading ? `<p class="text-red-500 text-xs mt-1">Nenhuma filial encontrada. Cadastre filiais primeiro.</p>` : ''}
                    </div>
                    <div>
                        <label for="dataExecucao" class="block text-sm font-medium text-gray-700 mb-1">Data de Execução</label>
                        <input
                            type="date"
                            id="dataExecucao"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                            required
                            ${formLoading ? 'disabled' : ''}
                        />
                    </div>
                    <div id="formMessageContainer">${formMessage ? (formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage)) : ''}</div>
                    <button
                        type="submit"
                        id="submitTrocaBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold text-lg"
                        ${formLoading || equipamentos.length === 0 || filiais.length === 0 ? 'disabled' : ''} <!-- Desabilita se estiver carregando ou sem dados para seleção -->
                    >
                        ${formLoading ? 'Registrando...' : 'Registrar Troca'}
                    </button>
                </form>
                `}
                <button
                    id="backToMenuBtn"
                    class="mt-6 w-full px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold"
                >
                    Voltar ao Menu
                </button>
            `);

            // Adiciona event listeners APÓS o HTML ser renderizado
            if (!dataLoading) {
                document.getElementById('trocaFilialFixaForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    formLoading = true;
                    formMessage = '';
                    document.getElementById('submitTrocaBtn').disabled = true;
                    document.getElementById('submitTrocaBtn').innerHTML = 'Registrando...';
                    document.getElementById('formMessageContainer').innerHTML = '';

                    const equipamentoId = document.getElementById('equipamento').value;
                    const novaFilialId = document.getElementById('novaFilial').value;
                    const dataExecucao = document.getElementById('dataExecucao').value;

                    try {
                        // Passo 1: Encontrar o registro de histórico ATUAL do equipamento (onde data_fim é NULL).
                        const { data: currentHistory, error: currentHistoryError } = await supabase
                            .from('historico_filiais_equipamentos')
                            .select('*')
                            .eq('equipamento_id', equipamentoId)
                            .is('data_fim', null) // Busca o registro ativo (sem data de fim)
                            .single(); // Espera apenas um resultado

                        if (currentHistoryError && currentHistoryError.code !== 'PGRST116') {
                            // PGRST116 significa "nenhuma linha encontrada", o que é esperado se não houver histórico.
                            // Outros erros são tratados.
                            throw new Error('Erro ao buscar histórico atual: ' + currentHistoryError.message);
                        }

                        // Passo 2: Se um histórico ATUAL for encontrado, encerrá-lo (definir data_fim).
                        if (currentHistory) {
                            const dataFimAntiga = new Date(dataExecucao);
                            // Define a data de fim como o dia anterior à data de execução da nova filial.
                            dataFimAntiga.setDate(dataFimAntiga.getDate() - 1);

                            const { error: updateError } = await supabase
                                .from('historico_filiais_equipamentos')
                                .update({ data_fim: dataFimAntiga.toISOString().split('T')[0] }) // Formata para 'YYYY-MM-DD'
                                .eq('id', currentHistory.id); // Atualiza o registro específico

                            if (updateError) {
                                throw new Error('Erro ao encerrar filial antiga: ' + updateError.message);
                            }
                        }

                        // Passo 3: Inserir o NOVO registro de histórico para a nova filial.
                        const { error: insertError } = await supabase
                            .from('historico_filiais_equipamentos')
                            .insert([
                                {
                                    equipamento_id: equipamentoId,
                                    filial_id: novaFilialId,
                                    data_inicio: dataExecucao,
                                    data_fim: null, // A nova filial é a atual, então data_fim é NULL
                                },
                            ]);

                        if (insertError) {
                            throw new Error('Erro ao registrar nova filial: ' + insertError.message);
                        }

                        formMessage = 'Troca de filial registrada com sucesso!';
                        // Limpa os campos do formulário
                        document.getElementById('equipamento').value = '';
                        document.getElementById('novaFilial').value = '';
                        document.getElementById('dataExecucao').value = '';
                    } catch (error) {
                        console.error('Erro na troca de filial:', error.message);
                        formMessage = 'Erro na troca de filial: ' + error.message;
                    } finally {
                        formLoading = false;
                        document.getElementById('submitTrocaBtn').disabled = false;
                        document.getElementById('submitTrocaBtn').innerHTML = 'Registrar Troca';
                        document.getElementById('formMessageContainer').innerHTML = formMessage.includes('sucesso') ? showSuccessMessage(formMessage) : showErrorMessage(formMessage);
                    }
                });
            }
            document.getElementById('backToMenuBtn').addEventListener('click', () => navigateTo('mainMenu'));

            // Inicia a busca pelos dados quando a tela é carregada
            if (dataLoading) {
                fetchData();
            }
        }

        /**
         * Renderiza a tela do Dashboard.
         * Exibe as filiais e os equipamentos ativos associados a um responsável selecionado.
         */
        async function renderDashboardScreen() {
            // Redireciona para o login se não houver um usuário autenticado
            if (!currentUser) { navigateTo('login'); return; }

            // Variáveis de estado locais para esta tela
            let message = ''; // Mensagem de feedback (ex: erro ao carregar)
            let loading = false; // Indica se os dados do dashboard estão sendo carregados
            let dataLoading = true; // Indica se a lista inicial de usuários está carregando
            let usuarios = []; // Lista de usuários para o filtro de responsável
            let filiaisDoResponsavel = []; // Filiais gerenciadas pelo responsável selecionado
            let equipamentosAtivos = {}; // Objeto para armazenar equipamentos ativos por ID da filial

            // Função interna para buscar a lista de usuários para o filtro
            const fetchUsuarios = async () => {
                try {
                    const { data, error } = await supabase.from('usuarios').select('id, nome');
                    if (error) throw error;
                    usuarios = data; // Armazena os usuários
                } catch (error) {
                    console.error('Erro ao buscar usuários:', error.message);
                    message = 'Erro ao carregar responsáveis: ' + error.message;
                } finally {
                    dataLoading = false; // Finaliza o carregamento inicial de usuários
                    renderDashboardScreen(); // Re-renderiza para exibir o select de usuários
                }
            };

            // Função interna para buscar os dados completos do dashboard com base no responsável
            const fetchDashboardData = async (responsavelId) => {
                // Limpa os dados se nenhum responsável for selecionado no filtro
                if (!responsavelId) {
                    filiaisDoResponsavel = [];
                    equipamentosAtivos = {};
                    loading = false;
                    renderDashboardScreen(); // Re-renderiza para limpar o dashboard
                    return;
                }

                loading = true; // Inicia o carregamento dos dados do dashboard
                message = ''; // Limpa mensagens anteriores
                filiaisDoResponsavel = []; // Limpa filiais anteriores
                equipamentosAtivos = {}; // Limpa equipamentos anteriores
                renderDashboardScreen(); // Atualiza a UI para mostrar o spinner de carregamento

                try {
                    // 1. Buscar filiais associadas ao responsável selecionado
                    const { data: filiaisData, error: filiaisError } = await supabase
                        .from('filiais')
                        .select('id, nome_filial')
                        .eq('responsavel_id', responsavelId); // Filtra as filiais pelo ID do responsável

                    if (filiaisError) throw filiaisError;
                    filiaisDoResponsavel = filiaisData; // Armazena as filiais encontradas

                    // 2. Para cada filial encontrada, buscar os equipamentos ativos associados.
                    for (const filial of filiaisData) {
                        const { data: historicoData, error: historicoError } = await supabase
                            .from('historico_filiais_equipamentos')
                            .select(`
                                *,
                                equipamentos (placa, tipo_equipamento) // Faz um JOIN implícito para obter dados do equipamento
                            `)
                            .eq('filial_id', filial.id)
                            .is('data_fim', null); // Condição para equipamentos que estão atualmente ativos (data_fim é NULL)

                        if (historicoError) {
                            console.error(`Erro ao buscar equipamentos para filial ${filial.nome_filial}:`, historicoError.message);
                            equipamentosAtivos[filial.id] = []; // Em caso de erro, define como array vazio
                            continue;
                        }

                        // Mapeia os dados do histórico para um formato mais fácil de renderizar,
                        // garantindo que as propriedades de 'equipamentos' existam (usando 'N/A' como fallback).
                        const activeEquipments = historicoData.map(item => ({
                            id: item.equipamento_id,
                            placa: item.equipamentos?.placa || 'N/A',
                            tipo_equipamento: item.equipamentos?.tipo_equipamento || 'N/A',
                            data_inicio: item.data_inicio,
                        }));
                        equipamentosAtivos[filial.id] = activeEquipments; // Armazena os equipamentos por filial
                    }
                } catch (error) {
                    console.error('Erro no dashboard:', error.message);
                    message = 'Erro ao carregar dados do dashboard: ' + error.message;
                } finally {
                    loading = false; // Finaliza o carregamento dos dados do dashboard
                    renderDashboardScreen(); // Re-renderiza com os dados ou a mensagem de erro
                }
            };

            // Constrói o HTML da tela do Dashboard
            updateScreenContent(`
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Dashboard de Equipamentos</h2>
                <div class="mb-6">
                    <label for="responsavelSelect" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Responsável</label>
                    <select
                        id="responsavelSelect"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                        ${loading || dataLoading || usuarios.length === 0 ? 'disabled' : ''} <!-- Desabilita se estiver carregando ou sem usuários -->
                    >
                        <option value="">Selecione um responsável</option>
                        ${usuarios.map(user => `<option value="${user.id}" ${user.id === (document.getElementById('responsavelSelect') ? document.getElementById('responsavelSelect').value : '') ? 'selected' : ''}>${user.nome}</option>`).join('')}
                    </select>
                    ${usuarios.length === 0 && !dataLoading ? `<p class="text-red-500 text-xs mt-1">Nenhum responsável encontrado. Cadastre usuários primeiro.</p>` : ''}
                </div>

                ${message ? showErrorMessage(message) : ''} <!-- Exibe mensagem de erro se houver -->
                ${loading ? `<div class="text-center text-gray-600"><div class="flex flex-col items-center justify-center p-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-2"></div><p class="text-gray-700">Carregando dados...</p></div></div>` : ''}

                ${!loading && (document.getElementById('responsavelSelect') ? document.getElementById('responsavelSelect').value : '') && filiaisDoResponsavel.length === 0 ? `<p class="text-center text-gray-600">Nenhuma filial encontrada para este responsável.</p>` : ''}

                ${!loading && (document.getElementById('responsavelSelect') ? document.getElementById('responsavelSelect').value : '') && filiaisDoResponsavel.length > 0 ? `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${filiaisDoResponsavel.map(filial => `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-md">
                                <h3 class="text-xl font-semibold text-blue-800 mb-4">${filial.nome_filial}</h3>
                                ${equipamentosAtivos[filial.id]?.length > 0 ? `
                                    <ul class="space-y-3">
                                        ${equipamentosAtivos[filial.id].map(equipamento => `
                                            <li class="bg-white p-3 rounded-md shadow-sm border border-gray-200">
                                                <p class="font-medium text-gray-800">Placa: <span class="font-normal">${equipamento.placa}</span></p>
                                                <p class="text-sm text-gray-600">Tipo: <span class="font-normal">${equipamento.tipo_equipamento}</span></p>
                                                <p class="text-xs text-gray-500">Desde: <span class="font-normal">${new Date(equipamento.data_inicio).toLocaleDateString('pt-BR')}</span></p>
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : `<p class="text-gray-600 text-sm">Nenhum equipamento ativo nesta filial.</p>`}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <button
                    id="backToMenuBtn"
                    class="mt-8 w-full px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out font-semibold"
                >
                    Voltar ao Menu
                </button>
            `, 'max-w-4xl'); // Define uma largura máxima maior para o dashboard

            // Adiciona event listeners APÓS o HTML ser renderizado
            if (!dataLoading) {
                const responsavelSelect = document.getElementById('responsavelSelect');
                if (responsavelSelect) {
                    responsavelSelect.addEventListener('change', (e) => {
                        fetchDashboardData(e.target.value); // Chama a função para buscar dados do dashboard com o novo responsável
                    });
                }
            }
            document.getElementById('backToMenuBtn').addEventListener('click', () => navigateTo('mainMenu'));

            // Inicia a busca pelos usuários quando a tela é carregada
            if (dataLoading) {
                fetchUsuarios();
            } else if (document.getElementById('responsavelSelect') && document.getElementById('responsavelSelect').value) {
                // Se já houver um responsável selecionado (ex: ao voltar para a tela), busca os dados do dashboard
                fetchDashboardData(document.getElementById('responsavelSelect').value);
            }
        }


        /**
         * Função principal que orquestra a renderização da tela correta.
         * É chamada sempre que o estado `currentScreen` ou `appLoading` muda.
         */
        function renderScreen() {
            // Se o aplicativo estiver em estado de carregamento inicial, exibe o spinner
            if (appLoading) {
                showLoadingSpinner('Inicializando aplicação...');
                return;
            }

            // Lógica de proteção de rota: se o usuário não estiver logado e tentar acessar
            // qualquer tela que não seja a de login, ele é automaticamente redirecionado para o login.
            if (!currentUser && currentScreen !== 'login') {
                currentScreen = 'login'; // Força a tela atual para 'login'
            }

            // Usa uma estrutura switch-case para chamar a função de renderização da tela apropriada
            switch (currentScreen) {
                case 'login':
                    renderLoginScreen();
                    break;
                case 'mainMenu':
                    renderMainMenu();
                    break;
                case 'cadastroFiliais':
                    renderCadastroFiliaisScreen();
                    break;
                case 'cadastroEquipamentos':
                    renderCadastroEquipamentosScreen();
                    break;
                case 'trocaFilialFixa':
                    renderTrocaFilialFixaScreen();
                    break;
                case 'dashboard':
                    renderDashboardScreen();
                    break;
                default:
                    renderLoginScreen(); // Por padrão, volta para a tela de login se a tela for desconhecida
            }
        }

        // --- Inicialização do Aplicativo ---
        // Garante que o DOM (Document Object Model) esteja completamente carregado
        // antes de tentar iniciar o aplicativo. Isso evita erros de elementos não encontrados.
        document.addEventListener('DOMContentLoaded', () => {
            appLoading = false; // Define o carregamento inicial como falso
            renderScreen(); // Inicia a renderização da primeira tela (login)
        });
    </script>
</body>
</html>
